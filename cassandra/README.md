# Cassandra Migration Tool

This guide walks through the various files and their role in performing a successful migration of Cassandra on DC/OS to Cassandra on Konvoy.

## Prerequisites

- `python3` installed in the environment
- DC/OS CLI `dcos` setup to talk to a DC/OS Cluster
- Kubernetes CLI `kubectl` setup to talk to a konvoy cluster
- Kudo CLI `kubectl kudo` setup to install operators
- Make sure Kudo is initiated `kubectl kudo init`
- Basic knowledge of kubernetes, kudo and Cassandra.
- Script is tested to work in Linux based environments.

## Commands

Python file located at `scripts/main.py` is the main entrypoint for the tooling used to migrate cassandra. The help menu describes the steps involved in migration:

```
➜ python3 ./cassandra/scripts/main.py --help

usage: main.py [-h] [--version] {backup,install} ...

positional arguments:
  {backup,install}  sub-commands available
    backup          Backup the DC/OS package data
    install         Translate the MesosCloud based configs to KubernetesCloud
                    based configs and print install instructions.

optional arguments:
  -h, --help        show this help message and exit
  --version         show program's version number and exit
``` 

### Overview 
At a higher level, migration can be seen as three steps:

1. Backup the DC/OS Cassandra configurations, metadata, and data locally.
2. Install Cassandra on Konvoy by translating the above downloaded configuration and adding other customization
3. Restore the backed up data from Cassandra on DC/OS to Cassandra on Konvoy.

These steps are explained in following steps:

### `1.backup`

By providing a service name or app-id (defaults to `/cassandra`), all the configuration and data backups can be downloaded to local file system.

```
➜ python3 ./cassandra/scripts/main.py backup --help

usage: main.py backup [-h] [-t TARGET_DIR] [--app-id APP_ID]

optional arguments:
  -h, --help            show this help message and exit
  -t TARGET_DIR, --target-dir TARGET_DIR
                        Folder to hold configuration of running DC/OS
                        Cassandra service (defaults to ./cassandra_home)
  --app-id APP_ID       Service Name (defaults to cassandra)
```

`TARGET_DIR` defaults to `$(pwd)/cassandra_home`.


### `2.install`

The `install` command generates a `TARGET_FILE` (that defaults to `$(pwd)/cassandra_home/params.yml` ) and prints instructions on how to use it to install in Cassandra on Konvoy. Other parameters such as `namespace` and `fullname` have sensible defaults in accordance with the upstream kudo operator definition but can be customized.

```
➜ python3 ./cassandra/scripts/main.py install --help

usage: main.py install [-h] [-c CONFIG_FILE] [-t TARGET_FILE]
                       [--namespace NAMESPACE] [--fullname FULLNAME]

optional arguments:
  -h, --help            show this help message and exit
  -c CONFIG_FILE, --config-file CONFIG_FILE
                        Path of the cassandra env file generated by backup
                        command. (defaults to
                        ./cassandra_home/cassandra_env.json)
  -t TARGET_FILE, --target-file TARGET_FILE
                        Path of the target params file (defaults to
                        ./cassandra_home/params.yml)
  --namespace NAMESPACE
                        Namespace of the cassandra pods (defaults to default)
  --fullname FULLNAME   Name of the Cassandra Kudo installation (defaults to
                        cassandra-instance)
```                        


### `3.migrate`

TBD


### Sample Output

Following is a sample output of running through all the commands. Note that all the flags provided are using their default values.

`backup` the Cassandra running on DC/OS with instance id `/cassandra` to a folder named `cassandra_home`

```
➜ python3 ./cassandra/scripts/main.py backup --app-id=cassandra --target-dir=$(pwd)/cassandra_home

[2020-11-20 08:30:43,219]  INFO {main.py:39} - Downloading DC/OS package with marathon app id cassandra into target directory <user_path>/dcos-migration/cassandra_home
[2020-11-20 08:30:43,219]  INFO {backup.py:41} - Validating DC/OS CLI is setup correctly
[2020-11-20 08:30:43,219]  INFO {backup.py:19} - Downloading configuration from task: cassandra__node-0-server__
[2020-11-20 08:30:43,219]  INFO {backup.py:19} - Downloading configuration from task: cassandra__node-1-server__
[2020-11-20 08:30:43,219]  INFO {backup.py:19} - Downloading configuration from task: cassandra__node-2-server__
```

`translate`

```
➜ python3 ./cassandra/scripts/main.py install -c $(pwd)/cassandra_home/cassandra_env.json -t $(pwd)/cassandra_home/params.yml --namespace default --fullname cassandra-instance

[2020-11-20 08:40:31,631]  INFO {main.py:75} - Translating Mesos configurations to K8s configurations
[2020-11-20 08:40:31,632]  INFO {translate.py:28} - Using "<user_path>/dcos-migration/cassandra_home/cassandra_env.json" file to migrate to kubernetes configuration at "<user_path>/dcos-migration/cassandra_home/params.yml"
--------------------------------------------------
Run the following command to install Cassandra on K8s: 
kubectl kudo install \
    --namespace default \
    --instance cassandra-instance \
    --parameter-file <user_path>/dcos-migration/cassandra_home/params.yml \
    --operator-version 3.11.5-0.1.2 \
    cassandra

--------------------------------------------------

WARNING: ALL THE PARAMETERS ARE GENERATED AS PER THE DCOS VERSION OF THE SERVICE, IT MIGHT NOT BE THE BEST FOR K8s.
SO BEFORE INSTALLING THE SERVICE PLEASE OPEN A TARGET FILE (<user-path>/dcos-migration/cassandra_home/params.yml) AND MODIFY VALUES AS PER THE AVAILABILITY ON THE K8s CLUSTER.
SPECIALLY VALUES OF THESE FIELDS SHOULD BE ADJUSTED AS PER THE CLUSTER:
NODE_COUNT
NODE_CPU_MC
NODE_CPU_LIMIT_MC
NODE_MEM_MIB
NODE_MEM_LIMIT_MIB
NODE_DISK_SIZE_GIB
NODE_TOPOLOGY
EXTERNAL_SEED_NODES

--------------------------------------------------
Run the following command to check the status: 
kubectl kudo plan status \
    --namespace default \
    --instance=cassandra-instance"

--------------------------------------------------
Make sure plan shows COMPELTE, before proceeding further.
--------------------------------------------------
```

Modify `<user-path>/dcos-migration/cassandra_home/params.yml` file as per your requirement and Copy paste the commands from above output to install the service.

TBD
